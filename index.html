<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Pharos Spin Game</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Ethers v6 -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.4/dist/ethers.umd.min.js"></script>
  <!-- Three.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.159.0/build/three.min.js"></script>
  <style>
    /* Fullscreen 3D canvas behind UI */
    #spinCanvas{
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      display: block;
    }
  </style>
</head>
<body class="bg-slate-900 text-white min-h-screen">

  <!-- Canvas background -->
  <canvas id="spinCanvas"></canvas>

  <!-- Simple UI on top -->
  <div class="relative z-10 flex flex-col items-center pt-16 gap-6">
    <h1 class="text-3xl md:text-4xl font-extrabold">
      ðŸŽ® Pharos Testnet Spin Game
    </h1>

    <button id="connectBtn"
      class="px-6 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-500 shadow-lg">
      Connect Wallet
    </button>

    <p id="status" class="text-sm text-slate-300"></p>
  </div>

  <script>
    // ---------- PHAROS NETWORK CONFIG ----------
    const PHAROS_RPC = "https://testnet.dplabs-internal.com";
    // 688,688 decimal -> 0xA8230 hex
    const PHAROS_CHAIN_ID_HEX = "0xA8230";
    const PHAROS_CHAIN_NAME = "Pharos Testnet";
    const PHAROS_EXPLORER = "https://testnet.pharosscan.xyz";

    // ---------- WALLET CONNECT ----------
    const statusEl = document.getElementById("status");
    const connectBtn = document.getElementById("connectBtn");

    let provider, signer;

    async function ensurePharosNetwork() {
      // Try switch first; if not added, add then switch.
      try {
        await window.ethereum.request({
          method: "wallet_switchEthereumChain",
          params: [{ chainId: PHAROS_CHAIN_ID_HEX }]
        });
      } catch (switchErr) {
        // If the chain is not added, add it
        if (switchErr && switchErr.code === 4902) {
          await window.ethereum.request({
            method: "wallet_addEthereumChain",
            params: [{
              chainId: PHAROS_CHAIN_ID_HEX,
              chainName: PHAROS_CHAIN_NAME,
              rpcUrls: [PHAROS_RPC],
              nativeCurrency: { name: "Pharos Test", symbol: "PHRS", decimals: 18 },
              blockExplorerUrls: [PHAROS_EXPLORER]
            }]
          });
        } else {
          throw switchErr;
        }
      }
    }

    async function connectWallet() {
      if (!window.ethereum) {
        statusEl.textContent = "MetaMask not found. Please install it.";
        return;
      }
      try {
        statusEl.textContent = "Connecting walletâ€¦";
        await ensurePharosNetwork();

        await window.ethereum.request({ method: "eth_requestAccounts" });
        provider = new ethers.BrowserProvider(window.ethereum);
        signer = await provider.getSigner();
        const addr = await signer.getAddress();

        statusEl.textContent = `Connected to Pharos as ${addr.slice(0, 6)}â€¦${addr.slice(-4)} â€” spinning!`;
        startSpinning(); // auto-start the game after connect
      } catch (err) {
        console.error(err);
        statusEl.textContent = `Connect error: ${err.message || err}`;
      }
    }

    connectBtn.addEventListener("click", connectWallet);

    // ---------- THREE.JS SPIN GAME ----------
    let scene, camera, renderer, cube, ring, spinning = false;

    init3D();
    animate();

    function init3D() {
      const canvas = document.getElementById("spinCanvas");

      renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.setSize(window.innerWidth, window.innerHeight);

      scene = new THREE.Scene();

      camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 100);
      camera.position.z = 6;

      // Lights
      const ambient = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambient);

      const point = new THREE.PointLight(0x22d3ee, 1.2);
      point.position.set(5, 5, 8);
      scene.add(point);

      // Main cube
      const geo = new THREE.BoxGeometry(1.4, 1.4, 1.4);
      const mat = new THREE.MeshStandardMaterial({ color: 0x22d3ee, roughness: 0.2, metalness: 0.7 });
      cube = new THREE.Mesh(geo, mat);
      scene.add(cube);

      // Neon ring
      const ringGeo = new THREE.TorusGeometry(2.4, 0.08, 16, 100);
      const ringMat = new THREE.MeshBasicMaterial({ color: 0x59f0ff, wireframe: true });
      ring = new THREE.Mesh(ringGeo, ringMat);
      ring.rotation.x = Math.PI / 3;
      scene.add(ring);

      // Resize
      window.addEventListener("resize", () => {
        renderer.setSize(window.innerWidth, window.innerHeight);
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
      });

      // Click/tap toggles spin (optional)
      canvas.addEventListener("click", () => {
        spinning = !spinning;
        statusEl.textContent = (spinning ? "Spinningâ€¦" : "Paused.") + " (click canvas to toggle)";
      });
    }

    function startSpinning() {
      spinning = true; // auto start after connect
    }

    function animate() {
      requestAnimationFrame(animate);

      // Idle motion
      ring.rotation.z += 0.002;

      if (spinning) {
        cube.rotation.x += 0.03;
        cube.rotation.y += 0.035;
      } else {
        // gentle idle movement when paused
        cube.rotation.y += 0.005;
      }

      renderer.render(scene, camera);
    }
  </script>
</body>
</html>

